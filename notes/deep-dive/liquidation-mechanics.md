# Liquidation Mechanics — 청산 메커니즘 심화

## 1. 청산 흐름 예시 (실제 숫자) / Liquidation Flow with Real Numbers

우리 `Scenario.t.sol` 테스트의 실제 계산을 그대로 사용한다.

### 초기 상태 / Initial State

```
프로토콜 파라미터:
  Liquidation Threshold (LT) = 80%
  Liquidation Bonus          = 5%
  Close Factor               = 50%

참여자:
  Bob (유동성 공급자): 50,000 USDC 예치
  Alice (차입자):      10 ETH 예치, 15,000 USDC 대출
  Liquidator:          대기 중

가격:
  ETH = $2,000
  USDC = $1
```

### Step 0: Alice의 건전한 포지션 / Alice's Healthy Position

```
담보 가치 = 10 ETH × $2,000 = $20,000
조정 담보 = $20,000 × LT(80%) = $16,000
부채 가치 = 15,000 USDC × $1  = $15,000

Health Factor = $16,000 / $15,000 = 1.067
→ HF > 1.0 이므로 안전. 청산 불가.
```

### Step 1: 가격 하락 → HF < 1 / Price Drop → HF < 1

```
ETH 가격: $2,000 → $1,500 (25% 하락)

새 담보 가치 = 10 ETH × $1,500 = $15,000
조정 담보    = $15,000 × 80%   = $12,000
부채 가치    = 15,000 USDC     = $15,000

Health Factor = $12,000 / $15,000 = 0.80
→ HF < 1.0! 청산 가능 상태!
```

이 시점에서 Alice는 아무것도 할 수 없다 (담보 추가 또는 부채 상환 하지 않는 한).
누구든 `liquidate()` 를 호출할 수 있다.

### Step 2: 청산자가 부채 일부 상환 / Liquidator Repays Partial Debt

```
Close Factor = 50%
최대 청산 가능 금액 = 15,000 × 50% = 7,500 USDC

청산자가 선택: debtToCover = 7,500 USDC (최대한 많이 청산)
→ 청산자가 자기 지갑에서 7,500 USDC를 풀에 전송
→ Alice의 debtToken 7,500개 소각
```

왜 50% 제한인가?
- 100% 청산 허용 시, 한 번에 모든 담보를 뺏을 수 있음
- 차입자에게 담보 추가 / 부채 상환 기회를 주기 위함
- 시장 안정성: 대량 담보 매각으로 인한 가격 폭락 방지

### Step 3: 청산자가 담보 + 보너스 수령 / Liquidator Receives Collateral + Bonus

```
담보 압류 공식:
  collateralSeized = debtToCover × debtPrice × (1 + bonus) / collateralPrice

  = 7,500 × $1 × 1.05 / $1,500
  = $7,875 / $1,500
  = 5.25 ETH

청산자가 받는 것: 5.25 ETH (시가 $7,875)
청산자가 지불한 것: 7,500 USDC ($7,500)
청산자 순이익: $7,875 - $7,500 = $375 (5%)
```

보너스가 왜 필요한가?
- 보너스 없으면 청산자에게 인센티브가 없음 (수수료만 손해)
- 보너스가 낮으면 → 청산자가 적어짐 → 프로토콜 위험 증가
- 보너스가 높으면 → 차입자 손실 증가 → 사용자 이탈
- Aave V3: 자산별 5~15% 차등 적용

### Step 4: 차입자의 부채 감소 / Borrower's Debt Decreases

```
청산 전 Alice:
  담보: 10.00 ETH ($15,000)
  부채: 15,000 USDC

청산 후 Alice:
  담보: 10.00 - 5.25 = 4.75 ETH ($7,125)
  부채: 15,000 - 7,500 = 7,500 USDC

새 HF = (4.75 × $1,500 × 80%) / 7,500 = $5,700 / $7,500 = 0.76
→ 여전히 HF < 1! 추가 청산 가능.
```

이 경우 2차 청산이 발생할 수 있다:
```
2차 청산: debtToCover = 7,500 × 50% = 3,750 USDC
→ seized = 3,750 × 1.05 / 1,500 = 2.625 ETH

2차 청산 후 Alice:
  담보: 4.75 - 2.625 = 2.125 ETH ($3,187.5)
  부채: 7,500 - 3,750 = 3,750 USDC
  HF = (2.125 × 1,500 × 0.80) / 3,750 = $2,550 / $3,750 = 0.68
```

### 전체 자금 흐름 다이어그램 / Full Fund Flow

```
              청산 전                                청산 후
     ┌─────────────────────┐            ┌─────────────────────┐
     │ Alice               │            │ Alice               │
     │ 담보: 10 ETH        │     →      │ 담보: 4.75 ETH      │
     │ 부채: 15,000 USDC   │            │ 부채: 7,500 USDC    │
     │ HF: 0.80            │            │ HF: 0.76            │
     └─────────────────────┘            └─────────────────────┘

     ┌─────────────────────┐            ┌─────────────────────┐
     │ Liquidator          │            │ Liquidator          │
     │ USDC: 100,000       │     →      │ USDC: 92,500        │
     │ WETH: 100           │            │ WETH: 105.25        │
     └─────────────────────┘            └─────────────────────┘
                                         순이익: $375 (5%)

     ┌─────────────────────┐            ┌─────────────────────┐
     │ Pool                │            │ Pool                │
     │ USDC 예치: 50,000   │     →      │ USDC 예치: 50,000   │
     │ USDC 대출: 15,000   │            │ USDC 대출: 7,500    │
     │ ETH 담보: 10        │            │ ETH 담보: 4.75      │
     └─────────────────────┘            └─────────────────────┘
```

---

## 2. 청산자가 없으면? / What If No Liquidator Acts?

### Bad Debt (부실 채권) 시나리오

```
시간순:

T=0: ETH $2,000 → $1,500 (HF = 0.80) — 청산 가능
T=1: 아무도 청산하지 않음
T=2: ETH $1,500 → $1,000 (HF = 0.53) — 더 위험해짐
T=3: ETH $1,000 → $500 (HF = 0.27) — 거의 회수 불가

이 시점에서:
  Alice 담보 가치: 10 × $500 = $5,000
  Alice 부채:      15,000 USDC
  → 담보 < 부채! "Underwater" 상태
  → 청산해도 부채를 완전히 회수할 수 없음 = Bad Debt
```

### Bad Debt가 프로토콜에 미치는 영향

```
                    정상 상태                    Bad Debt 상태
                ┌──────────────┐            ┌──────────────┐
Bob 예치금      │ 50,000 USDC  │            │ 50,000 USDC  │
                │ (전액 인출   │            │ (일부만 인출 │
                │  가능)       │            │  가능!)      │
                └──────────────┘            └──────────────┘
풀 실제 자금    │ 40,000 USDC  │            │ 35,000 USDC  │
대출 중         │ 10,000 USDC  │            │ 15,000 USDC  │
회수 불가       │    0 USDC    │            │ 10,000 USDC! │
                └──────────────┘            └──────────────┘

→ Bob이 50,000 USDC를 인출하려 하면 자금 부족!
→ "은행 뱅크런" 과 같은 상황 발생 가능
```

### 프로토콜별 Bad Debt 대응 방식

| 프로토콜 | 대응 방식 |
|---------|----------|
| **Aave V3** | Safety Module (stAAVE 스테이커가 손실 부담, 최대 30% 슬래싱) |
| **Compound V2** | 프로토콜 reserve로 충당, 부족하면 거버넌스 결정 |
| **Maker (DAI)** | MKR 토큰 경매 (새 MKR 발행하여 판매 → 부채 상환) |
| **Euler V2** | Dutch Auction으로 자동 가격 하락 → 더 빠른 청산 유도 |

Aave Safety Module 예시:
```
1. Bad Debt 발생: $1M USDC 회수 불가
2. 거버넌스 투표: Safety Module 활성화
3. stAAVE 스테이커의 AAVE 토큰 최대 30% 슬래싱
4. 슬래싱된 AAVE를 시장에 매각 → USDC 확보
5. Bad Debt 상환 → 예치자 보호
```

---

## 3. 청산자는 누구인가? / Who Are the Liquidators?

### 오픈 마켓 — 누구나 참여 가능

**청산은 프로토콜이 운영하는 것이 아니다.** 완전한 오픈 마켓이다.

```
참여자 유형:

1. 전문 청산 봇 (대부분의 청산)
   - MEV searcher들이 운영
   - 24/7 자동 모니터링 + 실행
   - Flashbots를 통해 MEV 보호

2. 개인 청산자
   - 직접 스크립트 작성
   - 소규모 청산 기회 노림

3. 프로토콜 자체 Keeper (소수)
   - Aave: Gauntlet/Chaos Labs가 위험 관리
   - 하지만 청산 자체는 외부에 의존

4. Flash Loan 청산자
   - 자본금 0으로 청산 가능!
   - Flash loan으로 빌려 → 청산 → 보너스 수령 → 상환
```

### Flash Loan 청산 흐름

```
하나의 트랜잭션 안에서:

1. Aave에서 7,500 USDC Flash Loan
2. 그 USDC로 Alice의 부채 청산
3. 5.25 ETH를 보너스 포함 수령
4. 5.25 ETH를 DEX에서 7,875 USDC로 스왑
5. 7,500 USDC + Flash Loan 수수료 상환
6. 나머지 ~$370 = 순이익

→ 자본금 없이 청산 가능!
→ 이것이 DeFi 청산이 효율적인 이유
```

### 청산 봇 아키텍처

```
┌──────────────────────────────────────────────────────────┐
│                    Liquidation Bot                        │
├──────────────────────────────────────────────────────────┤
│                                                          │
│  1. MONITOR (모니터링)                                    │
│     ├─ RPC Node → 블록마다 모든 포지션 HF 확인            │
│     ├─ The Graph → UserPosition 서브그래프 구독            │
│     └─ Chainlink Feed → 가격 변동 감시                    │
│                                                          │
│  2. SIMULATE (시뮬레이션)                                 │
│     ├─ eth_call로 청산 수익성 계산                         │
│     ├─ 가스비 vs 보너스 비교                               │
│     └─ DEX 슬리피지 계산 (담보 → 스테이블 변환 비용)        │
│                                                          │
│  3. EXECUTE (실행)                                        │
│     ├─ Flashbots Bundle로 MEV 보호                        │
│     ├─ Flash Loan 활용 (자본금 불필요)                     │
│     └─ 실패 시 재시도 로직                                 │
│                                                          │
│  모니터링: Prometheus + Grafana                           │
│     └─ 청산 성공률, 수익, 가스비, 경쟁자 수 추적            │
│                                                          │
└──────────────────────────────────────────────────────────┘
```

### 청산 경쟁 실태 / Liquidation Competition Reality

```
실제 MEV 경쟁 상황:

Block N: ETH 가격 하락 → Alice HF < 1

Searcher A: liquidate() 트랜잭션 제출 (가스 100 gwei)
Searcher B: 같은 청산 시도 (가스 200 gwei → A보다 먼저 실행됨)
Searcher C: Flashbots Bundle 제출 (Builder에게 직접 팁)

→ 보통 Searcher C가 승리 (MEV auction 메커니즘)
→ 청산 보너스의 상당 부분이 가스비/MEV 팁으로 소모됨
→ 시장이 효율적일수록 청산자 순이익 ↓
```

### 우리 프로토콜의 관점 / Our Protocol's Perspective

```
우리 LendingPool.sol의 liquidate() 함수:

- 누구나 호출 가능 (require(borrower != msg.sender) 외 제한 없음)
- Close Factor = 50%로 과도한 청산 방지
- Liquidation Bonus = 5%로 인센티브 제공
- 별도의 keeper/bot 시스템은 없음 → 외부 청산자에 의존

실제 배포 시 추가 고려 사항:
1. Backstop 메커니즘: 일정 시간 청산 안 되면 bonus 증가
2. Bad Debt 처리: Safety Module 또는 Treasury 필요
3. 청산 이벤트 emit → 봇이 구독할 수 있도록
```

---

## 4. Standard Liquidation vs Dutch Auction 비교

### 같은 시나리오로 두 방식 비교

```
공통 조건:
  Alice: 10 ETH 담보, 10,000 USDC 부채
  ETH 가격: $1,500 (하락 후)
  청산 대상: debtToCover = 5,000 USDC
```

### Standard Liquidation (Aave/Compound)

고정 보너스, 선착순.

```
보너스 = 5% (고정)
collateralSeized = 5,000 × 1.05 / 1,500 = 3.5 ETH

타임라인:
  T=0초: HF < 1 감지
  T=0초: Searcher A, B, C 모두 동시에 발견
  T=0초: 세 명 모두 같은 liquidate() tx 제출 → MEV 경쟁
  T=12초 (다음 블록): 가장 높은 tip을 낸 1명만 성공

결과:
  청산자: 5,000 USDC 지불 → 3.5 ETH ($5,250) 수령 → 순이익 $250
  Alice:  3.5 ETH 손실 (= $5,250, 부채 $5,000보다 $250 더 손해)

문제점:
  - 보너스가 항상 5% → 차입자가 항상 5% 추가 손해
  - 경쟁 심하면 $250 중 대부분이 Builder 팁으로 소모
  - 보너스가 너무 낮으면 아무도 청산 안 함 → Bad Debt
  - 보너스가 너무 높으면 차입자 과도한 손해 → 사용자 이탈
```

### Dutch Auction Liquidation (Euler)

시간이 지날수록 할인이 커짐. 시장이 "적정 보너스"를 결정.

```
Euler의 접근:
  경매 시작 시, 청산자가 받는 담보에 대한 "할인율"이 0%에서 시작하여
  시간이 지나면서 점점 증가한다.

코드:
  function liquidationPrice(uint256 elapsed) returns (uint256) {
      return startPrice * (auctionDuration - elapsed) / auctionDuration;
  }

  startPrice = 2 × marketPrice (담보 ETH의 유효 가격이 시장가의 2배에서 시작)
  auctionDuration = 30분
```

같은 시나리오를 시간순으로 추적:

```
T=0분: 유효 가격 = $3,000 (2× market)
  청산자가 5,000 USDC 내면 → 5,000/3,000 = 1.67 ETH ($2,500) 수령
  → 순손실 $2,500! 아무도 안 함.

T=5분: 유효 가격 = $2,500 (1.67×)
  5,000/2,500 = 2.0 ETH ($3,000) 수령
  → 순손실 $2,000. 여전히 안 함.

T=10분: 유효 가격 = $2,000 (1.33×)
  5,000/2,000 = 2.5 ETH ($3,750) 수령
  → 순손실 $1,250. 안 함.

T=15분: 유효 가격 = $1,500 (1× = 시장가)
  5,000/1,500 = 3.33 ETH ($5,000) 수령
  → 손익 $0. 가스비 고려하면 손해. 안 함.

★ T=16분: 유효 가격 = $1,400
  5,000/1,400 = 3.57 ETH ($5,357) 수령
  → 순이익 $357. 가스비 $15 빼면 $342.
  → 이 정도면 수익성 있음! 누군가 실행!

T=20분: (만약 아무도 안 했다면) 유효 가격 = $1,000
  5,000/1,000 = 5.0 ETH ($7,500) 수령
  → 순이익 $2,500. 매우 수익적 — 여기까지 올 일은 거의 없음.
```

결과 (T=16분에 청산된 경우):

```
  청산자: 5,000 USDC 지불 → 3.57 ETH ($5,357) 수령 → 순이익 ~$357
  Alice:  3.57 ETH 손실 (vs Standard의 3.5 ETH — 거의 동일하거나 약간 더)
```

### 핵심 차이 비교표

```
                    Standard (Aave)          Dutch Auction (Euler)
─────────────────────────────────────────────────────────────────
보너스 결정       고정 (5~15%)              시장이 결정 (시간 기반)
청산 속도         즉시 (같은 블록)           수 분~수십 분 소요
MEV 경쟁          극심 (선착순)             완화 (시간이 해결)
차입자 손해       항상 고정 %               최소한으로 수렴
Bad Debt 위험     보너스 < 가스비면 위험     시간 지나면 할인↑ → 결국 청산
구현 복잡도       간단                      경매 로직 추가 필요
가격 효율성       비효율 (고정가)           효율적 (시장 균형가)
─────────────────────────────────────────────────────────────────
```

### 왜 Dutch Auction이 더 효율적인가?

```
Standard의 문제:

  보너스 5% 고정
  → 경쟁이 심하면 실제 수익: 5% - 4.5%(팁) = 0.5%
  → 보너스의 90%가 Builder/Validator에게 감
  → 차입자는 항상 5% 손해인데, 청산자는 0.5%밖에 못 가져감
  → 비효율: 4.5%가 "낭비"됨

Dutch Auction의 해결:

  보너스가 0%에서 시작 → 점점 증가
  → 청산자는 "가스비 + 최소 이익"이 되는 순간 실행
  → 예: 2% 할인이면 실행 → 차입자는 2%만 손해
  → MEV 경쟁 완화: 빨리 하면 손해, 적정 시점에 하면 이득
  → 차입자에게 더 유리
```

```
시각화:

할인율
  ^
  |                          Standard: ─────── 항상 5%
  |                                    ▲
5%├──────────────────────────────────── - - - - - - -
  |                                  ╱
  |                      Dutch:    ╱  ← 누군가 여기서 실행 (~2%)
2%├─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ╱★
  |                            ╱
  |                          ╱
  |                        ╱
0%├───────────────────── ╱
  └──────────────────────────────────→ 시간
  0분                   16분       30분

  → Dutch Auction은 차입자 손해를 최소화하는 균형점을 자동으로 찾음
```

---

## 요약 / Summary

| 질문 | 답변 |
|------|------|
| 청산자는 누구? | **오픈 마켓** — 누구나 참여 가능, 대부분 자동화 봇 |
| 프로토콜이 직접 운영? | **아니오** — 외부 청산자에 의존 (인센티브로 유인) |
| 청산자가 없으면? | **Bad Debt** 발생 → 예치자 손실 위험 |
| Bad Debt 방어? | Safety Module, 거버넌스, 토큰 경매 등 프로토콜별 상이 |
| 자본금 없이 청산? | **가능** — Flash Loan 활용 |
| 청산 보너스 의미? | 청산자 인센티브이자 차입자 패널티 (트레이드오프) |
